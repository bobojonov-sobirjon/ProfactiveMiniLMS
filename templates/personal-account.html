{% extends 'base.html' %}
{% load static %}

{% block title %}Личный кабинет - Profactive{% endblock %}

{% block content %}
<!-- Main -->
  <!-- Мои курсы -->
  <section class="mb-12 md:mb-20 lg:mb-31 pt-8">
    <div>
      <div class="max-w-170 w-full mb-5 md:mb-8 lg:mb-13.5" data-aos="fade-up">
        <p class="font-medium md:text-lg lg:text-xl text-white/50 mb-3.5">
          Получайте {% if referral_discount %}{{ referral_discount.percentage|floatformat:0 }}{% else %}6{% endif %}% с каждой продажи!
        </p>

        <h2 class="text-2xl md:text-basic-40 lg:text-[54px]">
          Личный кабинет
        </h2>
      </div>

      <!-- Messages -->
      {% if messages %}
        <div class="mb-6">
          {% for message in messages %}
            <div class="p-4 rounded-[14px] mb-3 {% if message.tags == 'error' %}bg-red-100 text-red-700 border border-red-200{% elif message.tags == 'success' %}bg-green-100 text-green-700 border border-green-200{% elif message.tags == 'info' %}bg-blue-100 text-blue-700 border border-blue-200{% else %}bg-gray-100 text-gray-700 border border-gray-200{% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <!-- -->
      <div class="w-full">
        <!-- 1 -->
        <div class="bg-white text-primary rounded-3xl p-5 md:p-8 lg:p-11" data-aos="fade-up" data-aos-delay="200">
          <form action="{% url 'profile' %}" method="post">
            {% csrf_token %}
            <!-- Email -->
            <div class="space-y-2 lg:space-y-3.5 mb-5 lg:mb-8.5">
              <p class="font-semibold text-primary/90 text-base md:text-lg lg:text-xl">
                Email
              </p>
              <input type="email" name="email" id="email" value="{{ user.email }}"
                class="w-full border border-primary/20 rounded-[14px] px-6 py-3.5 lg:py-5 text-primary/50 font-normal placeholder:text-primary/50 outline-none bg-gray-100 cursor-not-allowed"
                placeholder="Email" disabled>
              <p class="text-sm text-gray-500">Email адрес нельзя изменить</p>
            </div>

            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-5 md:gap-8 lg:gap-11 mb-5 lg:mb-8.5">
              <!-- Фамилия -->
              <div class="space-y-2 lg:space-y-3.5">
                <p class="font-semibold text-primary/90 text-base md:text-lg lg:text-xl">
                  Фамилия
                </p>
                <input type="text" name="last_name" id="last_name" value="{{ user.last_name }}"
                  class="w-full border border-primary/20 rounded-[14px] px-6 py-3.5 lg:py-5 text-primary font-normal placeholder:text-primary/50 outline-none focus:border-primary"
                  placeholder="Фамилия" disabled>
              </div>
              <!-- Имя -->
              <div class="space-y-2 lg:space-y-3.5">
                <p class="font-semibold text-primary/90 text-base md:text-lg lg:text-xl">
                  Имя
                </p>
                <input type="text" name="first_name" id="first_name" value="{{ user.first_name }}"
                  class="w-full border border-primary/20 rounded-[14px] px-6 py-3.5 lg:py-5 text-primary font-normal placeholder:text-primary/50 outline-none focus:border-primary"
                  placeholder="Имя" disabled>
              </div>
              <!-- Отчество -->
              <div class="space-y-2 lg:space-y-3.5">
                <p class="font-semibold text-primary/90 text-base md:text-lg lg:text-xl">
                  Отчество
                </p>
                <input type="text" name="patronymic" id="patronymic" value="{{ user.patronymic }}"
                  class="w-full border border-primary/20 rounded-[14px] px-6 py-3.5 lg:py-5 text-primary font-normal placeholder:text-primary/50 outline-none focus:border-primary"
                  placeholder="Отчество">
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-5 md:gap-8 lg:gap-11 mb-5 lg:mb-8.5">
              <!-- Новый пароль -->
              <div class="space-y-2 lg:space-y-3.5">
                <p class="font-semibold text-primary/90 text-base md:text-lg lg:text-xl">
                  Новый пароль
                </p>
                <input type="password" name="new_password" id="new_password"
                  class="w-full border border-primary/20 rounded-[14px] px-6 py-3.5 lg:py-5 text-primary font-normal placeholder:text-primary/50 outline-none focus:border-primary"
                  placeholder="Новый пароль" minlength="8">
                <p class="text-sm text-gray-500 password-hint" id="new_password_hint" style="display: none;">Минимум 8 символов</p>
              </div>
              <!-- Новый пароль еще раз -->
              <div class="space-y-2 lg:space-y-3.5">
                <p class="font-semibold text-primary/90 text-base md:text-lg lg:text-xl">
                  Новый пароль еще раз
                </p>
                <input type="password" name="confirm_password" id="confirm_password"
                  class="w-full border border-primary/20 rounded-[14px] px-6 py-3.5 lg:py-5 text-primary font-normal placeholder:text-primary/50 outline-none focus:border-primary"
                  placeholder="Новый пароль еще раз" minlength="8">
                <p class="text-sm text-gray-500 password-hint" id="confirm_password_hint" style="display: none;">Повторите новый пароль</p>
              </div>
            </div>

            <div class="flex max-md:flex-col md:items-center justify-between gap-3.5 md:gap-5">
              <button type="submit"
                class="block w-fit font-semibold bg-gradient-display hover-opacity-75 text-primary lg:text-lg text-center leading-none rounded-full py-3.5 lg:py-5 px-7 md:px-10 lg:px-13">
                Сохранить
              </button>

              <a href="{% url 'logout' %}"
                class="block w-fit font-semibold border-2 border-red-500 hover:bg-red-500 hover:text-white text-red-500 lg:text-lg text-center leading-none rounded-full py-3.5 lg:py-5 px-7 md:px-10 lg:px-13 transition-colors">
                Выйти из системы
              </a>
            </div>

          </form>
        </div>
      </div>
    </div>
  </section>


    <!-- Уже зарегистрированы в реферальной программе? -->
    <section class="mb-12 md:mb-20 lg:mb-31">
      <div class="bg-gradient-banner min-h-111 rounded-3xl overflow-hidden">
        <div class="relative flex max-lg:flex-col lg:items-center justify-between gap-x-7 gap-y-6">
          <!-- Left -->
          <div class="px-4 md:px-6 lg:px-13.5 pt-6 lg:py-23.5 flex-1" data-aos="fade-right" data-aos-delay="100">
            <div class="w-full lg:max-w-145">
              <p class="font-medium md:text-lg lg:text-xl text-primary/50 mb-3.5">
                Получайте {% if referral_discount %}{{ referral_discount.percentage|floatformat:0 }}{% else %}6{% endif %}% с каждой продажи!
              </p>

              <h2 class="font-bold text-primary text-2xl md:text-3xl lg:text-basic-40/12.5 mb-6 md:mb-11 lg:mb-13.5">
                Уже зарегистрированы <br class="max-lg:hidden"> в реферальной программе?
              </h2>

              <a href="{% url 'referal' %}" class="inline-block bg-hover-primary font-semibold rounded-[14px] py-3.5 lg:py-5 px-7 lg:px-13.5">
                Узнать подробнее
              </a>
            </div>
          </div>
          <!-- Right -->
          <div class="md:max-w-90.5 relative max-lg:mx-auto lg:mr-32" data-aos="fade-left" data-aos-delay="200">
            <img class="relative z-0 size-full object-cover scale-[1.4]" src="{% static 'assets/images/IMG_20250924_141152_980.png' %}" width="100%" height="100%" alt="img">
          </div>

          <div class="max-lg:hidden absolute left-1/2 bottom-1/4 z-0 -translate-x-full translate-y-full text-primary">
            <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M32 0L40.6429 23.3571L64 32L40.6429 40.6429L32 64L23.3571 40.6429L0 32L23.3571 23.3571L32 0Z"
                fill="#1E1E1E" fill-opacity="0.882353" />
            </svg>
          </div>
          <div class="max-lg:hidden absolute right-0 top-0 z-0 -translate-x-11 translate-y-11">
            <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M32 0L40.6429 23.3571L64 32L40.6429 40.6429L32 64L23.3571 40.6429L0 32L23.3571 23.3571L32 0Z"
                fill="#1E1E1E" fill-opacity="0.882353" />
            </svg>
          </div>
        </div>
      </div>
    </section>

  </main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    
    form.addEventListener('submit', function(e) {
        // Clear previous error messages
        clearErrorMessages();
        
        // Validate password fields
        const newPassword = newPasswordInput.value.trim();
        const confirmPassword = confirmPasswordInput.value.trim();
        
        // If either password field has content, validate both
        if (newPassword || confirmPassword) {
            if (!newPassword) {
                showError(newPasswordInput, 'Введите новый пароль');
                e.preventDefault();
                return;
            }
            
            if (!confirmPassword) {
                showError(confirmPasswordInput, 'Подтвердите новый пароль');
                e.preventDefault();
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showError(confirmPasswordInput, 'Пароли не совпадают');
                e.preventDefault();
                return;
            }
            
            if (newPassword.length < 8) {
                showError(newPasswordInput, 'Пароль должен содержать минимум 8 символов');
                e.preventDefault();
                return;
            }
        }
        
        // Validate required fields
        const firstName = document.getElementById('first_name').value.trim();
        const lastName = document.getElementById('last_name').value.trim();
        
        if (!firstName) {
            showError(document.getElementById('first_name'), 'Имя обязательно для заполнения');
            e.preventDefault();
            return;
        }
        
        if (!lastName) {
            showError(document.getElementById('last_name'), 'Фамилия обязательна для заполнения');
            e.preventDefault();
            return;
        }
    });
    
    function showError(input, message) {
        // Remove existing error
        const existingError = input.parentNode.querySelector('.error-message');
        if (existingError) {
            existingError.remove();
        }
        
        // Add error styling
        input.classList.add('border-red-500');
        input.classList.remove('border-primary/20');
        
        // Add error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message text-red-500 text-sm mt-1';
        errorDiv.textContent = message;
        input.parentNode.appendChild(errorDiv);
    }
    
    function clearErrorMessages() {
        // Remove all error messages
        const errorMessages = document.querySelectorAll('.error-message');
        errorMessages.forEach(msg => msg.remove());
        
        // Reset input styles
        const inputs = document.querySelectorAll('input[type="text"], input[type="password"]');
        inputs.forEach(input => {
            input.classList.remove('border-red-500');
            input.classList.add('border-primary/20');
        });
    }
    
    // Show hints when user starts typing
    newPasswordInput.addEventListener('input', function() {
        const hint = document.getElementById('new_password_hint');
        if (this.value.trim().length > 0) {
            hint.style.display = 'block';
        } else {
            hint.style.display = 'none';
        }
    });
    
    confirmPasswordInput.addEventListener('input', function() {
        const hint = document.getElementById('confirm_password_hint');
        if (this.value.trim().length > 0) {
            hint.style.display = 'block';
        } else {
            hint.style.display = 'none';
        }
    });
    
    // Real-time password validation
    confirmPasswordInput.addEventListener('input', function() {
        const newPassword = newPasswordInput.value.trim();
        const confirmPassword = this.value.trim();
        
        if (confirmPassword && newPassword !== confirmPassword) {
            showError(this, 'Пароли не совпадают');
        } else {
            clearErrorMessages();
        }
    });
});
</script>
{% endblock %}