{% extends 'base.html' %}
{% load static %}

{% block title %}{{ course.name }} - –ú–æ–π –∫—É—Ä—Å{% endblock %}

{% block content %}
  <!-- Main -->
  <main class="container-base">
    <!-- Course Header -->
    <section class="mb-12 md:mb-20 lg:mb-31 pt-8">
      <div>
        <div class="w-full mb-5 md:mb-8 lg:mb-11" data-aos="fade-down" data-aos-delay="100">
          <div class="flex items-center gap-4 mb-3.5 min-w-0 md:flex-row flex-col justify-center items-center">
            <p class="font-medium md:text-lg lg:text-xl text-white/50 flex-shrink-0">
              {{ course.category.name }}
            </p>
            <h2 class="text-2xl md:text-basic-40 lg:text-[20px] text-center md:text-left text-force-wrap">
              {{ course.name }}
            </h2>
          </div>
        </div>

        <!-- Course Statistics -->
        <div class="flex flex-wrap gap-4 mb-6 md:mb-8 lg:mb-11" data-aos="fade-up" data-aos-delay="200">
          <div class="flex items-center gap-2 text-white/70">
            <span class="w-2 h-2 bg-gradient-display rounded-full"></span>
            <span class="font-medium">{{ total_lessons }} —É—Ä–æ–∫–æ–≤</span>
          </div>
          <div class="flex items-center gap-2 text-white/70">
            <span class="w-2 h-2 bg-gradient-display rounded-full"></span>
            <span class="font-medium">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫—É—Ä—Å–∞ - {{ total_duration_hours }} —á–∞—Å–æ–≤{% if total_duration_minutes > 0 %} {{ total_duration_minutes }} –º–∏–Ω—É—Ç{% endif %}</span>
          </div>
        </div>

        <div class="flex max-md:flex-col justify-between gap-4 lg:gap-6 mb-5 md:mb-8 lg:mb-11" data-aos="fade-right" data-aos-delay="300">
          <!-- Left -->
          <div class="max-w-198 w-full space-y-5 md:space-y-8 lg:space-y-11 flex-1 mb-10">
            <div class="rounded-3xl overflow-hidden">
              {% if course.image %}
                <img class="object-contain" src="{{ course.image.url }}" alt="{{ course.name }}">
              {% else %}
                <img class="object-contain" src="{% static 'assets/images/main-hero.png' %}" alt="{{ course.name }}">
              {% endif %}
            </div>
          </div>

          <!-- Right -->
          <div class="md:max-w-91 w-full flex-1" data-aos="fade-left" data-aos-delay="400">
            <!-- Course Content -->
            <div class="bg-white text-primary rounded-3xl p-4 lg:p-6">
              <div class="border-b border-primary/20 mb-4 lg:mb-6 pb-2 lg:pb-3.5">
                <h4 class="max-md:text-center font-semibold text-lg lg:text-basic-23">
                  –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫—É—Ä—Å–∞
                </h4>
              </div>
              <div class="space-y-2 md:space-y-3.5 text-primary/50">
                {% if chapters %}
                  {% for chapter in chapters %}
                    <div class="mb-4">
                      <div class="flex items-center justify-between">
                        <h5 class="font-semibold text-primary">{{ chapter.title }}</h5>
                        <div class="text-xs text-primary/50">
                          {% if chapter.is_accessible %}
                            <span class="text-green-600" style="font-size: 20px; color: #22c55e;"> ‚úì</span>
                          {% else %}
                            <span class="text-red-600" style="font-size: 20px; color: #ef4444;">‚úó</span>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <p class="font-medium text-primary/30">
                    –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–∞ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã
                  </p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Course Description - Full Width -->
        <div class="mb-8" data-aos="fade-up" data-aos-delay="400">
          <h3 class="text-2xl font-bold text-white mb-4">–û–ø–∏—Å–∞–Ω–∏–µ –∫—É—Ä—Å–∞</h3>
          <p class="text-white/70 leading-relaxed text-justify">
            {{ course.description }}
          </p>
        </div>

        <!-- Access Status -->
        <div class="mb-8" data-aos="fade-up" data-aos-delay="500">
          {% if is_enrolled %}
            <div class="bg-green-500/10 border border-green-500/30 rounded-2xl p-6 text-center">
              <div class="flex items-center justify-center mb-4">
                <svg class="w-8 h-8 text-green-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3 class="text-xl font-bold text-green-400">–î–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç!</h3>
              </div>
              <p class="text-green-300">–í—ã –º–æ–∂–µ—Ç–µ –∏–∑—É—á–∞—Ç—å –≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–∞</p>
            </div>
          {% else %}
            <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-2xl p-6 text-center">
              <div class="flex items-center justify-center mb-4">
                <svg class="w-8 h-8 text-yellow-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3 class="text-xl font-bold text-yellow-400">–û–∂–∏–¥–∞–µ—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</h3>
              </div>
              <p class="text-yellow-300">–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ</p>
            </div>
          {% endif %}
        </div>
    </section>

    <!-- Course Chapters with Expandable Content -->
    {% if is_enrolled and chapters %}
      <div class="mb-8 md:mb-12 lg:mb-16" data-aos="fade-up" data-aos-delay="700">
        <h3 class="text-xl md:text-2xl lg:text-3xl font-bold text-white mb-6 md:mb-8">
          –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫—É—Ä—Å–∞
        </h3>
        
        <div class="space-y-4">
          {% for chapter in chapters %}
            <div x-data="{ open: false }" class="bg-white/5 border-2 border-white/30 rounded-2xl overflow-hidden" data-aos="fade-up" data-aos-delay="{{ forloop.counter|add:700 }}">
              <!-- Chapter Header -->
              <button @click="open = !open" 
                class="w-full flex items-center justify-between p-4 lg:p-6 hover:bg-white/5 transition-colors"
                {% if not chapter.is_accessible %}disabled{% endif %}>
                <div class="flex items-center gap-4">
                  <span class="text-white/50 font-medium text-sm">{{ forloop.counter|stringformat:"02d" }}</span>
                  <h4 class="text-white font-semibold text-lg lg:text-xl {% if not chapter.is_accessible %}opacity-50{% endif %}">{{ chapter.title }}</h4>
                  {% if chapter.is_completed %}
                    <span class="text-green-400 ml-2 flex items-center gap-1">
                      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                      </svg>
                      <span class="text-sm font-medium">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                    </span>
                  {% elif not chapter.is_accessible %}
                    <span class="text-red-400 ml-2 flex items-center gap-1">
                      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                      </svg>
                      <span class="text-sm font-medium">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</span>
                    </span>
                  {% else %}
                    <span class="text-blue-400 ml-2 flex items-center gap-1">
                      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                      </svg>
                      <span class="text-sm font-medium">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>
                    </span>
                  {% endif %}
                </div>
                {% if chapter.is_accessible %}
                  <div class="p-2">
                    <svg :class="open ? 'rotate-45' : ''" class="transition-all duration-500 ease-in-out text-white/70" width="20" height="20"
                      viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M8.58325 8.5835V0.0834961H11.4166V8.5835H19.9166V11.4168H11.4166V19.9168H8.58325V11.4168H0.083252V8.5835H8.58325Z" fill="currentColor" />
                    </svg>
                  </div>
                {% endif %}
              </button>

              <!-- Chapter Content -->
              <div x-show="open" 
                   x-transition:enter="transition-all duration-500 ease-out"
                   x-transition:enter-start="opacity-0 max-h-0"
                   x-transition:enter-end="opacity-100 max-h-screen"
                   x-transition:leave="transition-all duration-500 ease-in"
                   x-transition:leave-start="opacity-100 max-h-screen"
                   x-transition:leave-end="opacity-0 max-h-0"
                   class="border-t-2 border-white/20 p-4 lg:p-6 overflow-hidden">
                <div class="space-y-4">
                  <!-- Videos Section -->
                  {% for video in chapter.coursevideoforordereduser_set.all %}
                    <div class="p-3 bg-white/5 border border-white/10 rounded-lg transition-all duration-300 hover:bg-white/10" data-video-id="{{ video.id }}">
                      <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-10 bg-gradient-display rounded-full flex items-center justify-center flex-shrink-0">
                          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 5V19L19 12L8 5Z" fill="white"/>
                          </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 video-title">
                              <p class="text-white font-medium break-words">{{ video.title }}</p>
                              {% load order_tags %}
                              {% is_video_watched video.id user as video_watched %}
                              {% if video_watched %}
                              <span class="text-green-400 flex items-center gap-1 watched-indicator">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-xs font-medium">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</span>
                              </span>
                            {% endif %}
                          </div>
                          {% if video.description %}
                            <p class="text-white/50 text-sm break-words mt-1">{{ video.description|truncatewords:15 }}</p>
                          {% endif %}
                        </div>
                      </div>
                        <div class="flex items-center justify-between">
                          <span class="text-white/50 text-sm">{{ video.video_time }}</span>
                          {% if video.is_accessible %}
                            <div class="flex items-center gap-3">
                              {% if video.is_watched %}
                                <span class="text-green-400 text-sm font-medium flex items-center gap-1">
                                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                  </svg>
                                  –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ
                                </span>
                              {% endif %}
                              <button onclick="openVideoModal('{{ video.get_file_url }}', '{{ video.title|escapejs }}', {{ video.id }})" class="text-blue-400 hover:text-blue-300 text-sm font-medium underline whitespace-nowrap flex items-center gap-1">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                  <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                                </svg>
                                –°–º–æ—Ç—Ä–µ—Ç—å
                              </button>
                            </div>
                          {% else %}
                            <div class="flex items-center gap-1 text-red-400">
                              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                              </svg>
                              <span class="text-sm">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</span>
                            </div>
                          {% endif %}
                        </div>
                    </div>
                  {% endfor %}

                  <!-- Materials Section -->
                  {% for material in chapter.coursematerialforordereduser_set.all %}
                    <div class="p-3 bg-white/5 border border-white/10 rounded-lg transition-all duration-300 hover:bg-white/10" data-material-id="{{ material.id }}">
                      <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 bg-gradient-display rounded-full flex items-center justify-center flex-shrink-0">
                          {% if material.material_type == 'image' %}
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M21 19V5C21 3.9 20.1 3 19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19ZM8.5 13.5L11 16.51L14.5 12L19 18H5L8.5 13.5Z" fill="white"/>
                            </svg>
                          {% else %}
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.89 22 5.99 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20Z" fill="white"/>
                            </svg>
                          {% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                          <p class="text-white font-medium break-words">{{ material.title }}</p>
                          {% if material.description %}
                            <p class="text-white/50 text-sm break-words mt-1">{{ material.description|truncatewords:15 }}</p>
                          {% endif %}
                        </div>
                      </div>
                      <div class="flex items-center justify-between">
                        <span class="text-white/50 text-sm">
                          {% if material.material_type == 'document' %}–î–æ–∫—É–º–µ–Ω—Ç{% else %}–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ{% endif %}
                        </span>
                        <div class="flex items-center gap-2">
                          {% if material.is_accessible %}
                            <a href="{{ material.get_file_url }}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm font-medium underline whitespace-nowrap">
                              –°–∫–∞—á–∞—Ç—å
                            </a>
                          {% else %}
                            <div class="flex items-center gap-1 text-red-400">
                              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                              </svg>
                              <span class="text-sm">–ó–∞–≤–µ—Ä—à–∏—Ç–µ –≥–ª–∞–≤—É</span>
                            </div>
                            <!-- Hidden download link for JavaScript -->
                            <a href="{{ material.get_file_url }}" target="_blank" class="hidden material-download-link" data-material-url="{{ material.get_file_url }}">
                              –°–∫–∞—á–∞—Ç—å
                            </a>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  {% endfor %}

                  {% if not chapter.coursevideoforordereduser_set.all and not chapter.coursematerialforordereduser_set.all %}
                    <p class="text-white/50 text-center py-4">–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –ø–æ–∫–∞ –Ω–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</p>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- Test Button - Show when all chapters are completed -->
    {% if not quiz_attempt %}
      <div class="mb-8 md:mb-12 lg:mb-16" data-aos="fade-up" data-aos-delay="800" data-test-button style="display: {% if all_chapters_completed %}block{% else %}none{% endif %};">
        <div class="bg-gradient-to-r from-green-500/20 to-blue-500/20 border-2 border-green-400/30 rounded-2xl p-8 text-center">
          <div class="flex items-center justify-center mb-4">
            <svg class="w-12 h-12 text-green-400 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h3 class="text-2xl font-bold text-green-400">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h3>
          </div>
          <p class="text-green-300 mb-6 text-lg">–í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤—Å–µ –≥–ª–∞–≤—ã –∫—É—Ä—Å–∞. –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –ø—Ä–æ–π—Ç–∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç.</p>
          <a href="{% url 'courses:start_quiz' course.id %}" 
             class="inline-flex items-center bg-gradient-display hover:opacity-75 font-semibold text-primary rounded-full px-8 py-4 text-lg transition-all duration-300">
            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç
          </a>
        </div>
      </div>
    {% endif %}

    <!-- Course Progress Card -->
    <div class="mb-8" data-aos="fade-up" data-aos-delay="550" data-order-id="{{ order.id }}">
      <div class="bg-white text-primary rounded-3xl p-4 md:p-7 lg:p-11">
        <div class="flex max-md:flex-col justify-between gap-2 md:gap-3 lg:gap-5 max-md:mb-3 md:mb-4 lg:mb-5">
          <div>
            <p class="font-medium text-primary/50 text-sm md:text-base lg:text-xl max-md:mb-2 md:mb-3">
              –ö—É—Ä—Å
            </p>

            <h2 class="md:hidden text-primary !font-semibold text-lg md:text-xl lg:text-basic-40/12.5">
              {{ course.name }}
            </h2>
          </div>

          <div class="whitespace-nowrap flex max-sm:flex-col-reverse sm:items-center gap-2 md:gap-3 lg:gap-6">
            <a href="{% url 'referal' %}"
              class="w-fit hover-opacity-75 font-semibold border-2 border-brand-green-600 px-4 md:px-6 lg:px-8.5 py-2 md:py-2.5 rounded-full text-sm md:text-base">
              –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
            </a>

            {% if is_enrolled %}
              {% if quiz_attempt %}
                {% if quiz_attempt.is_passed %}
                  <!-- Test Passed - Show Results Button -->
                  <a href="{% url 'courses:quiz_results' course.id %}"
                  class="w-fit bg-green-500 hover:bg-green-600 font-semibold text-white rounded-full px-4 md:px-6 lg:px-8.5 py-2 md:py-2.5 continue-button text-sm md:text-base">
                  –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞
                  </a>
                {% else %}
                  <!-- Test Failed - Show Retake Button -->
                  <a href="{% url 'courses:start_quiz' course.id %}"
                  class="w-fit bg-yellow-500 hover:bg-yellow-600 font-semibold text-white rounded-full px-4 md:px-6 lg:px-8.5 py-2 md:py-2.5 continue-button text-sm md:text-base">
                  –ü–µ—Ä–µ—Å–¥–∞—Ç—å —Ç–µ—Å—Ç
                  </a>
                {% endif %}
              {% else %}
                <!-- No Test Attempt - Show Take Test Button -->
                <a href="{% url 'courses:start_quiz' course.id %}"
                class="w-fit bg-gradient-display hover-opacity-75 font-semibold text-primary rounded-full px-4 md:px-6 lg:px-8.5 py-2 md:py-2.5 continue-button text-sm md:text-base">
                –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç
                </a>
              {% endif %}
            {% else %}
              <!-- Continue Learning Button -->
              <a href="{% url 'courses:ordered_course_detail' order.id %}"
                class="w-fit bg-gradient-display hover-opacity-75 font-semibold text-primary rounded-full px-4 md:px-6 lg:px-8.5 py-2 md:py-2.5 continue-button text-sm md:text-base">
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ
              </a>
            {% endif %}
          </div>
        </div>
        
        <h2 class="max-md:hidden text-primary !font-semibold text-lg md:text-2xl lg:text-basic-40/12.5 md:mb-6 lg:mb-8.5">
          {{ course.name }}
        </h2>

        <div class="flex max-md:flex-col justify-between gap-2 md:gap-3 lg:gap-5">
          <div class="flex flex-wrap w-full gap-2 md:gap-3 lg:gap-6">
            <p class="text-sm md:text-base lg:text-base font-semibold text-primary progress-percentage">
              {{ progress_percentage }}%
            </p>
            <div class="w-full max-w-111 h-4.5 bg-primary/20 rounded-full">
              <div class="h-full bg-gradient-display rounded-full progress-bar transition-all duration-500" 
                   style="width: {{ progress_percentage }}%; min-width: 0;"></div>
            </div>
            <p class="text-primary/50 font-medium text-xs md:text-sm lg:text-base leading-none">
              <span class="watched-videos">{{ watched_videos }}</span>/<span class="total-videos">{{ total_videos }}</span> –≤–∏–¥–µ–æ, {{ total_videos }} —á–∞—Å–æ–≤, {{ total_videos }} –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏—Ö —á–∞—Å–æ–≤
            </p>
          </div>              
        </div>
      </div>
    </div>

    <!-- Quiz Results Card -->
    {% if quiz_attempt %}
      <div class="mb-8" data-aos="fade-up" data-aos-delay="600">
        <div class="bg-white text-primary rounded-3xl p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-primary">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞</h3>
            {% if quiz_attempt.is_passed %}
              <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                –ü—Ä–æ–π–¥–µ–Ω
              </span>
            {% else %}
              <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">
                –ù–µ –ø—Ä–æ–π–¥–µ–Ω
              </span>
            {% endif %}
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="text-center">
              <div class="text-2xl font-bold text-primary">{{ quiz_attempt.score }}</div>
              <div class="text-primary/70 text-sm">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-primary">{{ quiz_attempt.percentage|floatformat:1 }}%</div>
              <div class="text-primary/70 text-sm">–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-primary">{{ quiz_attempt.time_taken|floatformat:0 }}</div>
              <div class="text-primary/70 text-sm">–°–µ–∫—É–Ω–¥</div>
            </div>
          </div>
          
          <div class="quiz-results-buttons">
            <a href="{% url 'courses:quiz_results' course.id %}" 
               class="bg-gradient-display hover:opacity-75 font-semibold text-primary rounded-full px-6 py-3 text-center transition-all duration-300">
              –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            </a>
            {% if quiz_attempt.is_passed and quiz_certificate %}
              <a href="{% url 'courses:quiz_certificate' course.id %}" 
                 class="certificate-button border-2 border-primary text-primary hover:bg-primary hover:text-primary/70 font-semibold rounded-full px-6 py-3 text-center transition-all duration-300">
                –°–∫–∞—á–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
              </a>
            {% else %}
              <a href="{% url 'courses:start_quiz' course.id %}" 
                 class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-full px-6 py-3 text-center transition-all duration-300">
                –ü–µ—Ä–µ—Å–¥–∞—Ç—å —Ç–µ—Å—Ç
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    {% endif %}

    <br>
    <div class="whitespace-nowrap flex max-sm:flex-col sm:items-center gap-3 lg:gap-6" data-aos="fade-up" data-aos-delay="600">
      <a href="{% url 'courses:my_courses' %}"
        class="w-fit bg-gradient-display hover-opacity-75 font-semibold text-primary rounded-[14px] px-6 md:px-8.5 lg:px-11 py-2.5 lg:py-4">
        –ú–æ–∏ –∫—É—Ä—Å—ã
      </a>
      <a href="{% url 'course-catalogue' %}"
        class="w-fit font-semibold border-gradient-rounded-14 rounded-[14px] px-6 md:px-8.5 lg:px-11 py-2.5 lg:py-4">
        –í—Å–µ –∫—É—Ä—Å—ã
      </a>
    </div>
  </div>
  </main>

  <!-- Video Modal -->
  <div id="videoModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75" style="display: none;">
    <!-- Modal Content -->
    <div class="relative w-full max-w-4xl mx-4 bg-black rounded-lg overflow-hidden shadow-2xl">
      <!-- Modal Header -->
      <div class="flex items-center justify-between p-3 bg-gradient-display text-white">
        <h3 id="videoTitle" class="text-lg font-semibold truncate pr-2"></h3>
        <button onclick="closeVideoModal()" class="text-gray-200 hover:text-white transition-colors flex-shrink-0">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <!-- Video Player -->
      <div class="relative bg-black">
        <video 
          id="videoPlayer"
          controls 
          class="w-full h-auto max-h-[70vh]"
          preload="metadata">
          –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç.
        </video>
      </div>
      
      <!-- Navigation Buttons - Outside video player -->
      <div class="bg-black/90 backdrop-blur-sm border-t border-white/10 p-4">
        <div class="flex justify-between items-center">
          <button 
            id="prevVideoBtn"
            class="nav-btn prev-btn bg-gradient-display hover-opacity-75 font-semibold text-primary disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed text-white px-6 py-3 rounded-xl flex items-center gap-3 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:hover:scale-100 font-medium"
            disabled>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path>
            </svg>
            <span class="hidden sm:inline">–ü—Ä–µ–¥—ã–¥—É—â–µ–µ</span>
            <span class="sm:hidden">‚Üê</span>
          </button>
          
          <div class="video-counter bg-black/80 backdrop-blur-sm text-white text-sm px-4 py-2 rounded-xl border border-white/20 shadow-lg text-center">
            <div class="flex flex-col items-center">
              <div class="flex items-center gap-2">
                <span id="currentVideoNumber" class="font-bold text-blue-300">1</span> 
                <span class="text-white/70">/</span> 
                <span id="totalVideos" class="font-bold text-white">1</span>
              </div>
              <div id="chapterTitle" class="text-xs text-white/60 mt-1 truncate max-w-48"></div>
            </div>
          </div>
          
          <button 
            id="nextVideoBtn"
            class="nav-btn next-btn bg-gradient-display hover-opacity-75 font-semibold text-primary disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed text-white px-6 py-3 rounded-xl flex items-center gap-3 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:hover:scale-100 font-medium"
            disabled>
            <span id="nextBtnText" class="hidden sm:inline">–°–ª–µ–¥—É—é—â–µ–µ</span>
            <span id="nextBtnIcon" class="sm:hidden">‚Üí</span>
            <svg id="nextBtnSvg" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    #videoModal {
      animation: fadeIn 0.3s ease-out;
    }
    
    #videoModal .relative {
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from { 
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    #videoPlayer {
      border-radius: 0;
    }
    
    @media (max-width: 640px) {
      #videoModal .relative {
        margin: 0.5rem;
        width: calc(100vw - 1rem);
        max-width: calc(100vw - 1rem);
      }
      
      #videoPlayer {
        max-height: 50vh;
      }
    }
    
    @media (min-width: 641px) {
      #videoModal .relative {
        width: 90vw;
        max-width: 80rem;
      }
      
      #videoPlayer {
        max-height: 75vh;
      }
    }
    
    #videoPlayer {
      border-radius: 0;
      object-fit: contain;
    }
    
    /* Navigation buttons styling */
    .nav-btn {
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .nav-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .nav-btn:hover:not(:disabled)::before {
      left: 100%;
    }
    
    .nav-btn:hover:not(:disabled) {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
    }
    
    .nav-btn:active:not(:disabled) {
      transform: translateY(0) scale(0.98);
      transition: transform 0.1s;
    }
    
    .nav-btn:disabled {
      cursor: not-allowed;
      transform: none;
      opacity: 0.5;
    }
    
    .video-counter {
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Mobile responsiveness */
    @media (max-width: 640px) {
      .nav-btn {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
      }
      
      .video-counter {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
      }
    }
    
    /* Animation for button press */
    @keyframes buttonPress {
      0% { transform: scale(1); }
      50% { transform: scale(0.95); }
      100% { transform: scale(1); }
    }
    
    .nav-btn:active:not(:disabled) {
      animation: buttonPress 0.1s ease-in-out;
    }
  </style>

  <script>
    let currentVideoId = null;
    let videoStartTime = null;
    let hasMarkedAsWatched = false;
    let allCourseVideos = [];
    let currentVideoIndex = 0;
    let eventListenersAdded = false;
    let nextButtonClicks = 0;
    let prevButtonClicks = 0;

    function openVideoModal(url, title, videoId) {
      currentVideoId = videoId;
      hasMarkedAsWatched = false;
      videoStartTime = Date.now();
      
      // Load all course videos if not already loaded
      if (allCourseVideos.length === 0) {
        loadAllCourseVideos();
      }
      
      // Find and set current video index
      currentVideoIndex = allCourseVideos.findIndex(video => video.id == videoId);
      
      document.getElementById('videoTitle').textContent = title;
      document.getElementById('videoPlayer').src = url;
      document.getElementById('videoModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      // Update navigation buttons
      updateNavigationButtons();
      
      // Add event listeners only once
      if (!eventListenersAdded) {
        const videoPlayer = document.getElementById('videoPlayer');
        videoPlayer.addEventListener('ended', markVideoAsWatched);
        videoPlayer.addEventListener('timeupdate', checkVideoProgress);
        
        // Add button event listeners
        document.getElementById('nextVideoBtn').addEventListener('click', playNextVideo);
        document.getElementById('prevVideoBtn').addEventListener('click', playPreviousVideo);
        
        eventListenersAdded = true;
      }
    }

    function loadAllCourseVideos() {
      allCourseVideos = [];
      
      // Get all chapters in order
      const allChapters = document.querySelectorAll('[x-data]');
      
      allChapters.forEach((chapter, chapterIndex) => {
        const chapterTitle = chapter.querySelector('h4')?.textContent || `Chapter ${chapterIndex + 1}`;
        
        // Get all videos in this chapter
        const chapterVideos = chapter.querySelectorAll('[data-video-id]');
        
        chapterVideos.forEach((video, videoIndex) => {
          const titleElement = video.querySelector('.video-title p');
          const buttonElement = video.querySelector('button[onclick*="openVideoModal"]');
          
          if (titleElement && buttonElement) {
            const onclickAttr = buttonElement.getAttribute('onclick');
            const urlMatch = onclickAttr.match(/'([^']+)'/);
            
            const videoData = {
              id: video.getAttribute('data-video-id'),
              title: titleElement.textContent,
              url: urlMatch ? urlMatch[1] : '',
              chapterTitle: chapterTitle,
              chapterIndex: chapterIndex,
              videoIndex: videoIndex
            };
            
            allCourseVideos.push(videoData);
          }
        });
      });
    }

    function closeVideoModal() {
      document.getElementById('videoModal').style.display = 'none';
      const videoPlayer = document.getElementById('videoPlayer');
      videoPlayer.pause();
      videoPlayer.src = '';
      document.body.style.overflow = 'auto';
      
      // Remove event listeners
      videoPlayer.removeEventListener('ended', markVideoAsWatched);
      videoPlayer.removeEventListener('timeupdate', checkVideoProgress);
      
      currentVideoId = null;
      videoStartTime = null;
      hasMarkedAsWatched = false;
      // Don't clear allCourseVideos - keep it for next time
      currentVideoIndex = 0;
    }

    function updateNavigationButtons() {
      const prevBtn = document.getElementById('prevVideoBtn');
      const nextBtn = document.getElementById('nextVideoBtn');
      const currentVideoNumber = document.getElementById('currentVideoNumber');
      const totalVideos = document.getElementById('totalVideos');
      const chapterTitle = document.getElementById('chapterTitle');
      const nextBtnText = document.getElementById('nextBtnText');
      const nextBtnIcon = document.getElementById('nextBtnIcon');
      const nextBtnSvg = document.getElementById('nextBtnSvg');
      
      if (prevBtn) {
        prevBtn.disabled = currentVideoIndex <= 0;
        prevBtn.style.opacity = currentVideoIndex <= 0 ? '0.5' : '1';
      }
      
      if (nextBtn) {
        const isLastVideo = currentVideoIndex >= allCourseVideos.length - 1;
        nextBtn.disabled = false; // Never disable, just change text
        
        if (isLastVideo) {
          // Last video - show "Start Over" button
          if (nextBtnText) {
            nextBtnText.textContent = '–°–º–æ—Ç—Ä–µ—Ç—å —Å–Ω–∞—á–∞–ª–∞';
          }
          if (nextBtnIcon) {
            nextBtnIcon.textContent = 'üîÑ';
          }
          if (nextBtnSvg) {
            nextBtnSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>';
          }
          nextBtn.classList.remove('bg-gradient-display');
          nextBtn.classList.add('bg-gradient-to-r', 'from-green-600', 'to-green-700', 'hover:from-green-700', 'hover:to-green-800');
        } else {
          // Not last video - show "Next" button
          if (nextBtnText) {
            nextBtnText.textContent = '–°–ª–µ–¥—É—é—â–µ–µ';
          }
          if (nextBtnIcon) {
            nextBtnIcon.textContent = '‚Üí';
          }
          if (nextBtnSvg) {
            nextBtnSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>';
          }
          nextBtn.classList.remove('bg-gradient-to-r', 'from-green-600', 'to-green-700', 'hover:from-green-700', 'hover:to-green-800');
          nextBtn.classList.add('bg-gradient-display');
        }
      }
      
      if (currentVideoNumber) {
        currentVideoNumber.textContent = currentVideoIndex + 1;
      }
      
      if (totalVideos) {
        totalVideos.textContent = allCourseVideos.length;
      }
      
      if (chapterTitle && allCourseVideos[currentVideoIndex]) {
        chapterTitle.textContent = allCourseVideos[currentVideoIndex].chapterTitle;
      }
    }

    function playPreviousVideo() {
      // Count button clicks
      prevButtonClicks++;
      console.log('=== PREVIOUS BUTTON CLICKED ===');
      console.log('Next button clicks:', nextButtonClicks);
      console.log('Previous button clicks:', prevButtonClicks);
      console.log('Total button clicks:', nextButtonClicks + prevButtonClicks);
      
      if (currentVideoIndex > 0) {
        // Add button press effect
        const btn = document.getElementById('prevVideoBtn');
        btn.style.transform = 'scale(0.95)';
        setTimeout(() => {
          btn.style.transform = '';
        }, 100);
        
        // Go to previous video
        currentVideoIndex = currentVideoIndex - 1;
        const prevVideo = allCourseVideos[currentVideoIndex];
        
        if (prevVideo) {
          // Update video player
          currentVideoId = prevVideo.id;
          hasMarkedAsWatched = false;
          videoStartTime = Date.now();
          
          document.getElementById('videoTitle').textContent = prevVideo.title;
          const videoPlayer = document.getElementById('videoPlayer');
          videoPlayer.src = prevVideo.url;
          videoPlayer.load(); // Force reload the video
          videoPlayer.play(); // Auto play the new video
          
          // Update navigation buttons
          updateNavigationButtons();
        }
      }
    }

    function playNextVideo() {
      // Count button clicks
      nextButtonClicks++;
      console.log('=== NEXT BUTTON CLICKED ===');
      console.log('Next button clicks:', nextButtonClicks);
      console.log('Previous button clicks:', prevButtonClicks);
      console.log('Total button clicks:', nextButtonClicks + prevButtonClicks);
      console.log('currentVideoIndex', currentVideoIndex);
      console.log('allCourseVideos.length', allCourseVideos.length);
      
      // Add button press effect
      const btn = document.getElementById('nextVideoBtn');
      btn.style.transform = 'scale(0.95)';
      setTimeout(() => {
        btn.style.transform = '';
      }, 100);
      
      if (currentVideoIndex < allCourseVideos.length - 1) {
        // Go to next video
        currentVideoIndex = currentVideoIndex + 1;
        const nextVideo = allCourseVideos[currentVideoIndex];
        console.log('nextVideo', nextVideo);
        if (nextVideo) {
          // Update video player
          currentVideoId = nextVideo.id;
          hasMarkedAsWatched = false;
          videoStartTime = Date.now();
          
          document.getElementById('videoTitle').textContent = nextVideo.title;
          const videoPlayer = document.getElementById('videoPlayer');
          videoPlayer.src = nextVideo.url;
          videoPlayer.load(); // Force reload the video
          videoPlayer.play(); // Auto play the new video
          
          // Update navigation buttons
          updateNavigationButtons();
        }
      } else {
        // Last video - start over from beginning
        currentVideoIndex = 0;
        const firstVideo = allCourseVideos[currentVideoIndex];
        
        if (firstVideo) {
          // Update video player
          currentVideoId = firstVideo.id;
          hasMarkedAsWatched = false;
          videoStartTime = Date.now();
          
          document.getElementById('videoTitle').textContent = firstVideo.title;
          const videoPlayer = document.getElementById('videoPlayer');
          videoPlayer.src = firstVideo.url;
          videoPlayer.load(); // Force reload the video
          videoPlayer.play(); // Auto play the new video
          
          // Update navigation buttons
          updateNavigationButtons();
        }
      }
    }

    function checkVideoProgress() {
      const videoPlayer = document.getElementById('videoPlayer');
      if (videoPlayer.duration > 0) {
        const watchedPercentage = (videoPlayer.currentTime / videoPlayer.duration) * 100;
        // Mark as watched if user watched more than 80% of the video
        if (watchedPercentage >= 99 && !hasMarkedAsWatched) {
          markVideoAsWatched();
        }
      }
    }

    function markVideoAsWatched() {
      if (!currentVideoId || hasMarkedAsWatched) return;
      
      hasMarkedAsWatched = true;
      
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                       document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
      
      if (!csrfToken) {
        console.error('CSRF token not found');
        return;
      }

      fetch('{% url "courses:mark_video_watched" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          video_id: currentVideoId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('Video marked as watched:', data);
          // Show success message
          showNotification('–í–∏–¥–µ–æ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–µ!', 'success');
          // Update UI without reload
          updateVideoStatus(currentVideoId);
        } else {
          console.error('Error marking video as watched:', data.message);
          showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –≤–∏–¥–µ–æ', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –≤–∏–¥–µ–æ', 'error');
      });
    }

    function updateVideoStatus(videoId) {
      // Find the video element and add watched indicator
      const videoElement = document.querySelector(`[data-video-id="${videoId}"]`);
      if (videoElement) {
        const titleElement = videoElement.querySelector('.video-title');
        if (titleElement && !titleElement.querySelector('.watched-indicator')) {
          const watchedIndicator = document.createElement('span');
          watchedIndicator.className = 'text-green-400 flex items-center gap-1 watched-indicator';
          watchedIndicator.innerHTML = `
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-xs font-medium">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</span>
          `;
          titleElement.appendChild(watchedIndicator);
        }
      }
      
      // Update chapter status
      updateChapterStatus(videoId);
      
      // Unlock materials for current chapter
      unlockMaterialsForChapter(videoId);
    }

    function updateChapterStatus(videoId) {
      // Find the current chapter
      const videoElement = document.querySelector(`[data-video-id="${videoId}"]`);
      if (!videoElement) return;
      
      const chapterElement = videoElement.closest('[x-data]');
      if (!chapterElement) return;
      
      // Check if all videos in this chapter are watched
      const allVideos = chapterElement.querySelectorAll('[data-video-id]');
      let allWatched = true;
      
      allVideos.forEach(video => {
        if (!video.querySelector('.watched-indicator')) {
          allWatched = false;
        }
      });
      
      if (allWatched) {
        // Update chapter status to completed
        const chapterHeader = chapterElement.querySelector('button');
        if (chapterHeader) {
          const statusElement = chapterHeader.querySelector('.text-blue-400, .text-red-400, .text-green-400');
          if (statusElement) {
            statusElement.className = 'text-green-400 ml-2 flex items-center gap-1';
            statusElement.innerHTML = `
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
              <span class="text-sm font-medium">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
            `;
          }
        }
        
        // Unlock next chapter
        unlockNextChapter(chapterElement);
        
        // Check if all chapters are completed and show test button
        checkAllChaptersCompleted();
      }
    }

    function unlockMaterialsForChapter(videoId) {
      // Find the current chapter
      const videoElement = document.querySelector(`[data-video-id="${videoId}"]`);
      if (!videoElement) return;
      
      const chapterElement = videoElement.closest('[x-data]');
      if (!chapterElement) return;
      
      // Find all materials in this chapter
      const materials = chapterElement.querySelectorAll('[data-material-id]');
      
      materials.forEach(material => {
        // Find the button container
        const buttonContainer = material.querySelector('.flex.items-center.gap-2');
        if (!buttonContainer) return;
        
        // Check if material is currently locked
        const lockedDiv = buttonContainer.querySelector('.text-red-400');
        const hiddenLink = buttonContainer.querySelector('.material-download-link');
        
        if (lockedDiv && hiddenLink) {
          // Get the download URL from hidden link
          const downloadUrl = hiddenLink.getAttribute('data-material-url');
          
          // Replace locked content with download link
          buttonContainer.innerHTML = `
            <a href="${downloadUrl}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm font-medium underline whitespace-nowrap">
              –°–∫–∞—á–∞—Ç—å
            </a>
          `;
        }
      });
    }

    function unlockNextChapter(currentChapterElement) {
      // Find the next chapter
      const allChapters = document.querySelectorAll('[x-data]');
      let currentIndex = -1;
      
      allChapters.forEach((chapter, index) => {
        if (chapter === currentChapterElement) {
          currentIndex = index;
        }
      });
      
      if (currentIndex >= 0 && currentIndex < allChapters.length - 1) {
        const nextChapter = allChapters[currentIndex + 1];
        const nextChapterHeader = nextChapter.querySelector('button');
        
        if (nextChapterHeader) {
          // Remove disabled attribute
          nextChapterHeader.removeAttribute('disabled');
          
          // Update status to "–í –ø—Ä–æ—Ü–µ—Å—Å–µ"
          const statusElement = nextChapterHeader.querySelector('.text-red-400');
          if (statusElement) {
            statusElement.className = 'text-blue-400 ml-2 flex items-center gap-1';
            statusElement.innerHTML = `
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
              <span class="text-sm font-medium">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>
            `;
          }
          
          // Add expand/collapse button
          const expandButton = nextChapterHeader.querySelector('.p-2');
          if (!expandButton) {
            const expandDiv = document.createElement('div');
            expandDiv.className = 'p-2';
            expandDiv.innerHTML = `
              <svg :class="open ? 'rotate-45' : ''" class="transition-all duration-500 ease-in-out text-white/70" width="20" height="20"
                viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8.58325 8.5835V0.0834961H11.4166V8.5835H19.9166V11.4168H11.4166V19.9168H8.58325V11.4168H0.083252V8.5835H8.58325Z" fill="currentColor" />
              </svg>
            `;
            nextChapterHeader.appendChild(expandDiv);
          }
          
          // Update chapter title opacity
          const titleElement = nextChapterHeader.querySelector('h4');
          if (titleElement) {
            titleElement.classList.remove('opacity-50');
          }
        }
      }
    }

    function checkAllChaptersCompleted() {
      // Check if all chapters are completed
      const allChapters = document.querySelectorAll('[x-data]');
      let allCompleted = true;
      
      allChapters.forEach(chapter => {
        const statusElement = chapter.querySelector('.text-green-400');
        if (!statusElement || !statusElement.textContent.includes('–ó–∞–≤–µ—Ä—à–µ–Ω–æ')) {
          allCompleted = false;
        }
      });
      
      // Show or hide test button based on completion status
      const testButtonSection = document.querySelector('[data-test-button]');
      if (testButtonSection) {
        if (allCompleted) {
          testButtonSection.style.display = 'block';
          testButtonSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          testButtonSection.style.display = 'none';
        }
      }
    }

    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white font-medium ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Remove notification after 3 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }

    // Close modal when clicking outside
    document.getElementById('videoModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeVideoModal();
      }
    });

    // Close modal with Escape key and navigation with arrow keys
    // Keyboard navigation (disabled to prevent double execution)
    // document.addEventListener('keydown', function(e) {
    //   if (e.key === 'Escape') {
    //     closeVideoModal();
    //   } else if (e.key === 'ArrowLeft' && document.getElementById('videoModal').style.display === 'flex') {
    //     playPreviousVideo();
    //   } else if (e.key === 'ArrowRight' && document.getElementById('videoModal').style.display === 'flex') {
    //     playNextVideo();
    //   }
    // });

    // Event listeners are added in openVideoModal function

    // Function to update progress bar
    function updateProgressBar(orderId, progressData) {
      const progressElement = document.querySelector(`[data-order-id="${orderId}"] .progress-percentage`);
      const progressBarElement = document.querySelector(`[data-order-id="${orderId}"] .progress-bar`);
      const watchedElement = document.querySelector(`[data-order-id="${orderId}"] .watched-videos`);
      const totalElement = document.querySelector(`[data-order-id="${orderId}"] .total-videos`);
      
      if (progressElement) {
        progressElement.textContent = progressData.percentage + '%';
      }
      
      if (progressBarElement) {
        progressBarElement.style.width = progressData.percentage + '%';
      }
      
      if (watchedElement) {
        watchedElement.textContent = progressData.watched_videos;
      }
      
      if (totalElement) {
        totalElement.textContent = progressData.total_videos;
      }
      
      // Update button if completed
      if (progressData.is_completed) {
        const continueButton = document.querySelector(`[data-order-id="${orderId}"] .continue-button`);
        if (continueButton) {
          continueButton.innerHTML = '–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç';
          continueButton.classList.remove('bg-gradient-display');
          continueButton.classList.add('bg-green-500');
        }
      }
    }

    // Function to mark video as watched
    function markVideoWatched(videoId, orderId) {
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                       document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
      
      if (!csrfToken) {
        console.error('CSRF token not found');
        return;
      }

      fetch('{% url "courses:mark_video_watched" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          video_id: videoId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('Video marked as watched:', data);
          updateProgressBar(orderId, data.progress);
        } else {
          console.error('Error marking video as watched:', data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }

    // Function to refresh progress from server
    function refreshProgress(orderId) {
      // This will be called when returning from video page
      location.reload();
    }
  </script>

  <style>
    /* Fix for certificate button hover issue */
    .certificate-button {
      position: relative;
      z-index: 10;
      display: inline-block;
    }
    
    .certificate-button:hover {
      opacity: 1 !important;
      visibility: visible !important;
      display: inline-block !important;
    }
    
    /* Ensure button container doesn't collapse */
    .quiz-results-buttons {
      display: flex !important;
      flex-direction: row;
      gap: 12px;
      align-items: center;
    }
    
    @media (max-width: 640px) {
      .quiz-results-buttons {
        flex-direction: column;
      }
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .bg-gradient-display {
      background: linear-gradient(135deg, #F0E263 0%, #C28D31 100%);
    }
    
    .hover-opacity-75:hover {
      opacity: 0.75;
    }
    
    .progress-bar {
      transition: width 0.5s ease-in-out;
    }
  </style>
{% endblock %}
