{% extends 'base.html' %}
{% load static %}

{% block title %}Просмотр результатов{% endblock %}

{% block content %}
  <!-- Main -->
  <main class="container-base">
    <!-- Header -->
    <section class="mb-12 md:mb-20 lg:mb-31 pt-8">
      <div class="text-center mb-8 md:mb-12">
        <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-4">
          Просмотр результатов
        </h1>
        <p class="text-white/70 text-lg">
          Посмотрите свой прогресс по курсам
        </p>
      </div>

      <!-- DEBUG: course_progress count = {{ course_progress|length }} -->
      {% if course_progress %}
        <div class="space-y-2 md:space-y-3 lg:space-y-6">
          {% for progress in course_progress %}
            <!-- DEBUG: Processing course {{ progress.course.name }} -->
            <section class="mb-4 md:mb-6 lg:mb-12 pt-4 md:pt-6 lg:pt-8" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:100 }}" data-order-id="{{ progress.order.id }}">
              <div class="bg-white text-primary rounded-3xl p-4 md:p-7 lg:p-11">
                <div class="flex max-md:flex-col justify-between gap-2 md:gap-3 lg:gap-5 max-md:mb-3 md:mb-4 lg:mb-5">
                  <div>
                    <p class="font-medium text-primary/50 text-sm md:text-base lg:text-xl max-md:mb-2 md:mb-3">
                      Курс
                    </p>

                    <h2 class="md:hidden text-primary !font-semibold text-lg md:text-xl lg:text-basic-40/12.5">
                      {{ progress.course.name }}
                    </h2>
                  </div>

                  <div class="whitespace-nowrap flex max-sm:flex-col-reverse sm:items-center gap-2 md:gap-3 lg:gap-6">
                    <a href="{% url 'referal' %}"
                      class="w-fit hover-opacity-75 font-semibold border-2 border-brand-green-600 px-4 md:px-6 lg:px-8.5 py-2 md:py-2.5 rounded-full text-sm md:text-base">
                      Реферальная программа
                    </a>

                    {% if progress.is_completed %}
                      {% if progress.quiz_attempt %}
                        {% if progress.quiz_passed %}
                          <!-- Test Passed - Show Results Button -->
                          <a href="{% url 'courses:quiz_results' progress.course.id %}"
                          class="w-fit bg-green-500 hover:bg-green-600 font-semibold text-white rounded-full px-4 md:px-6 lg:px-8.5 py-2 md:py-2.5 continue-button text-sm md:text-base">
                          Результаты теста
                        </a>
                        {% else %}
                          <!-- Test Failed - Show Retake Button -->
                          <a href="{% url 'courses:start_quiz' progress.course.id %}"
                          class="w-fit bg-yellow-500 hover:bg-yellow-600 font-semibold text-white rounded-full px-4 md:px-6 lg:px-8.5 py-2 md:py-2.5 continue-button text-sm md:text-base">
                          Пересдать тест
                        </a>
                        {% endif %}
                      {% else %}
                        <!-- No Test Attempt - Show Take Test Button -->
                        <a href="{% url 'courses:start_quiz' progress.course.id %}"
                        class="w-fit bg-gradient-display hover-opacity-75 font-semibold text-primary rounded-full px-4 md:px-6 lg:px-8.5 py-2 md:py-2.5 continue-button text-sm md:text-base">
                        Пройти тест
                      </a>
                      {% endif %}
                    {% else %}
                      <!-- Continue Learning Button -->
                      <a href="{% url 'courses:ordered_course_detail' progress.order.id %}"
                        class="w-fit bg-gradient-display hover-opacity-75 font-semibold text-primary rounded-full px-4 md:px-6 lg:px-8.5 py-2 md:py-2.5 continue-button text-sm md:text-base">
                        Продолжить обучение
                      </a>
                    {% endif %}
                  </div>
                </div>
                
                <h2 class="max-md:hidden text-primary !font-semibold text-lg md:text-2xl lg:text-basic-40/12.5 md:mb-6 lg:mb-8.5">
                  {{ progress.course.name }}
                </h2>

                <div class="flex max-md:flex-col justify-between gap-2 md:gap-3 lg:gap-5">
                  <div class="flex flex-wrap w-full gap-2 md:gap-3 lg:gap-6">
                    <p class="text-sm md:text-base lg:text-base font-semibold text-primary progress-percentage">
                      {{ progress.progress_percentage }}%
                    </p>
                    <div class="w-full max-w-111 h-4.5 bg-primary/20 rounded-full">
                      <div class="h-full bg-gradient-display rounded-full progress-bar transition-all duration-500" 
                           style="width: {{ progress.progress_percentage }}%"></div>
                    </div>
                    <p class="text-primary/50 font-medium text-xs md:text-sm lg:text-base leading-none">
                      <span class="watched-videos">{{ progress.watched_videos }}</span>/<span class="total-videos">{{ progress.total_videos }}</span> видео, {{ progress.total_videos }} часов, {{ progress.total_videos }} академических часов
                    </p>
                  </div>
                  <a href="{% url 'courses:ordered_course_detail' progress.order.id %}"
                    class="font-medium whitespace-nowrap underline underline-offset-4 text-primary transition duration-200 hover:text-primary/75 text-sm md:text-base">
                    Учебный план
                  </a>
                </div>
              </div>
            </section>
          {% endfor %}
        </div>
      {% else %}
        <!-- Empty State -->
        <div class="text-center py-16">
          <div class="w-24 h-24 mx-auto mb-6 bg-white/10 rounded-full flex items-center justify-center">
            <svg class="w-12 h-12 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-white mb-2">Пока нет курсов</h3>
          <p class="text-white/70 mb-6">Закажите свой первый курс и начните обучение</p>
          <a href="{% url 'course-catalogue' %}" 
             class="inline-flex items-center bg-gradient-display hover-opacity-75 font-semibold text-primary rounded-[14px] px-6 py-3 transition-all duration-300">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Выбрать курс
          </a>
        </div>
      {% endif %}
    </section>
  </main>

  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .bg-gradient-display {
      background: linear-gradient(135deg, #F0E263 0%, #C28D31 100%);
    }
    
    .hover-opacity-75:hover {
      opacity: 0.75;
    }
    
    .progress-bar {
      transition: width 0.5s ease-in-out;
    }
  </style>

  <script>
    // Function to update progress bar
    function updateProgressBar(orderId, progressData) {
      const progressElement = document.querySelector(`[data-order-id="${orderId}"] .progress-percentage`);
      const progressBarElement = document.querySelector(`[data-order-id="${orderId}"] .progress-bar`);
      const watchedElement = document.querySelector(`[data-order-id="${orderId}"] .watched-videos`);
      const totalElement = document.querySelector(`[data-order-id="${orderId}"] .total-videos`);
      
      if (progressElement) {
        progressElement.textContent = progressData.percentage + '%';
      }
      
      if (progressBarElement) {
        progressBarElement.style.width = progressData.percentage + '%';
      }
      
      if (watchedElement) {
        watchedElement.textContent = progressData.watched_videos;
      }
      
      if (totalElement) {
        totalElement.textContent = progressData.total_videos;
      }
      
      // Update button if completed
      if (progressData.is_completed) {
        const continueButton = document.querySelector(`[data-order-id="${orderId}"] .continue-button`);
        if (continueButton) {
          continueButton.innerHTML = 'Пройти тест';
          continueButton.classList.remove('bg-gradient-display');
          continueButton.classList.add('bg-green-500');
        }
      }
    }

    // Function to mark video as watched
    function markVideoWatched(videoId, orderId) {
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                       document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
      
      if (!csrfToken) {
        console.error('CSRF token not found');
        return;
      }

      fetch('{% url "courses:mark_video_watched" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          video_id: videoId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('Video marked as watched:', data);
          updateProgressBar(orderId, data.progress);
        } else {
          console.error('Error marking video as watched:', data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }

    // Function to refresh progress from server
    function refreshProgress(orderId) {
      // This will be called when returning from video page
      location.reload();
    }
  </script>
{% endblock %}
