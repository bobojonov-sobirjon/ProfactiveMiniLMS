{% extends 'base.html' %}
{% load static %}

{% block title %}{{ quiz.title }} - {{ course.name }}{% endblock %}

{% block content %}
  <!-- Main -->
  <main class="container-base">
    <!-- Quiz Header -->
    <section class="mb-12 md:mb-20 lg:mb-31 pt-8">
      <div class="text-center mb-8 md:mb-12">
        <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-4">
          {{ quiz.title }}
        </h1>
        <p class="text-white/70 text-lg">
          {{ course.name }}
        </p>
        {% if quiz.description %}
          <p class="text-white/50 text-base mt-4">
            {{ quiz.description }}
          </p>
        {% endif %}
      </div>

      <!-- Quiz Info -->
      <div class="bg-white/10 border border-white/20 rounded-2xl p-6 mb-8 sticky top-4 z-30">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
          <div>
            <div class="text-2xl font-bold text-white">{{ questions|length }}</div>
            <div class="text-white/70">Вопросов</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-white" id="timeDisplay">{{ quiz.time_limit }}:00</div>
            <div class="text-white/70">Осталось времени</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-white">{{ quiz.passing_score }}%</div>
            <div class="text-white/70">Проходной балл</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-white" id="progressDisplay">0/{{ questions|length }}</div>
            <div class="text-white/70">Отвечено</div>
          </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="mt-6">
          <div class="w-full bg-white/20 rounded-full h-3">
            <div id="progressBar" class="h-3 rounded-full bg-gradient-to-r from-yellow-400 to-yellow-600 transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Quiz Form -->
    <section class="mb-8">
      <form id="quizForm" method="post" action="{% url 'courses:submit_quiz' course.id %}">
        {% csrf_token %}
        
        <div class="space-y-6">
          {% for question in questions %}
            <div class="bg-white text-primary rounded-3xl p-6 question-card" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:100 }}" data-question="{{ forloop.counter }}">
              <div class="mb-6">
                <div class="flex items-center gap-3 mb-4">
                  <span class="bg-gradient-display text-primary font-bold rounded-full w-10 h-10 flex items-center justify-center text-sm">
                    {{ forloop.counter }}
                  </span>
                  <h3 class="text-lg font-semibold text-primary">Вопрос {{ forloop.counter }} из {{ questions|length }}</h3>
                  <div class="ml-auto">
                    <span class="text-sm text-primary/60" id="status_{{ question.id }}">Не отвечен</span>
                  </div>
                </div>
                <p class="text-primary text-base leading-relaxed font-medium">{{ question.question_text }}</p>
              </div>

              <div class="space-y-3">
                <label class="flex items-center p-4 border-2 border-primary/20 rounded-xl hover:border-primary/40 transition-all duration-200 cursor-pointer option-label" data-option="A">
                  <input type="radio" name="question_{{ question.id }}" value="A" class="mr-4 text-primary focus:ring-primary option-radio">
                  <div class="flex items-center w-full">
                    <span class="bg-primary/10 text-primary font-bold rounded-full w-8 h-8 flex items-center justify-center text-sm mr-3">A</span>
                    <span class="text-primary font-medium flex-1">{{ question.option_a }}</span>
                  </div>
                </label>
                
                <label class="flex items-center p-4 border-2 border-primary/20 rounded-xl hover:border-primary/40 transition-all duration-200 cursor-pointer option-label" data-option="B">
                  <input type="radio" name="question_{{ question.id }}" value="B" class="mr-4 text-primary focus:ring-primary option-radio">
                  <div class="flex items-center w-full">
                    <span class="bg-primary/10 text-primary font-bold rounded-full w-8 h-8 flex items-center justify-center text-sm mr-3">B</span>
                    <span class="text-primary font-medium flex-1">{{ question.option_b }}</span>
                  </div>
                </label>
                
                <label class="flex items-center p-4 border-2 border-primary/20 rounded-xl hover:border-primary/40 transition-all duration-200 cursor-pointer option-label" data-option="C">
                  <input type="radio" name="question_{{ question.id }}" value="C" class="mr-4 text-primary focus:ring-primary option-radio">
                  <div class="flex items-center w-full">
                    <span class="bg-primary/10 text-primary font-bold rounded-full w-8 h-8 flex items-center justify-center text-sm mr-3">C</span>
                    <span class="text-primary font-medium flex-1">{{ question.option_c }}</span>
                  </div>
                </label>
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Submit Button -->
        <div class="text-center mt-8">
          <button type="submit" id="submitBtn" 
                  class="bg-gradient-display hover:opacity-75 font-semibold text-primary rounded-full px-8 py-4 text-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
            <span id="submitText">Завершить тест</span>
            <span id="submitCount" class="ml-2 text-sm">(0/{{ questions|length }} отвечено)</span>
          </button>
        </div>
      </form>
    </section>
  </main>

  <!-- Timer Modal -->
  <div id="timerModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75" style="display: none;">
    <div class="bg-white text-primary rounded-3xl p-8 text-center max-w-md mx-4">
      <div class="text-6xl font-bold text-red-500 mb-4" id="timerDisplay">30:00</div>
      <h3 class="text-2xl font-bold mb-4">Время истекает!</h3>
      <p class="text-primary/70 mb-6">У вас осталось мало времени для завершения теста</p>
      <button onclick="closeTimerModal()" class="bg-gradient-display hover:opacity-75 font-semibold text-primary rounded-full px-6 py-3">
        Понятно
      </button>
    </div>
  </div>

  <!-- Loading Modal -->
  <div id="loadingModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75" style="display: none;">
    <div class="bg-white text-primary rounded-3xl p-8 text-center max-w-md mx-4">
      <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary mx-auto mb-4"></div>
      <h3 class="text-2xl font-bold mb-4">Обработка результатов...</h3>
      <p class="text-primary/70">Пожалуйста, подождите</p>
    </div>
  </div>

  <style>
    .bg-gradient-display {
      background: linear-gradient(135deg, #F0E263 0%, #C28D31 100%);
    }
    
    .hover-opacity-75:hover {
      opacity: 0.75;
    }

    /* Custom radio button styling */
    input[type="radio"] {
      width: 20px;
      height: 20px;
      accent-color: #F0E263;
    }

    /* Selected option styling */
    label:has(input[type="radio"]:checked) {
      border-color: #F0E263 !important;
      background-color: rgba(240, 226, 99, 0.1);
    }
  </style>

  <script>
    let timeLeft = {{ quiz.time_limit }} * 60; // Convert minutes to seconds
    let timerInterval;
    let isSubmitted = false;
    let answeredQuestions = 0;
    const totalQuestions = {{ questions|length }};

    // Start timer
    function startTimer() {
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        updateProgress();
        
        if (timeLeft <= 0) {
          submitQuiz();
        } else if (timeLeft <= 300 && timeLeft > 0) { // Show warning at 5 minutes
          showTimerWarning();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      const timeDisplay = document.getElementById('timeDisplay');
      timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      // Change color when time is running low
      if (timeLeft <= 300) {
        timeDisplay.className = 'text-2xl font-bold text-red-400';
      } else if (timeLeft <= 600) {
        timeDisplay.className = 'text-2xl font-bold text-yellow-400';
      } else {
        timeDisplay.className = 'text-2xl font-bold text-white';
      }
    }

    function updateProgress() {
      answeredQuestions = document.querySelectorAll('input[type="radio"]:checked').length;
      const progressPercentage = (answeredQuestions / totalQuestions) * 100;
      
      // Update progress display
      document.getElementById('progressDisplay').textContent = `${answeredQuestions}/${totalQuestions}`;
      document.getElementById('progressBar').style.width = `${progressPercentage}%`;
      document.getElementById('submitCount').textContent = `(${answeredQuestions}/${totalQuestions} отвечено)`;
      
      // Update individual question status
      document.querySelectorAll('.question-card').forEach(card => {
        const questionId = card.querySelector('input[type="radio"]:checked')?.name.replace('question_', '');
        const statusElement = document.getElementById(`status_${questionId}`);
        if (statusElement) {
          statusElement.textContent = 'Отвечен';
          statusElement.className = 'text-sm text-green-600 font-medium';
        }
      });
    }

    function showTimerWarning() {
      if (timeLeft <= 300 && timeLeft > 0) {
        document.getElementById('timerModal').style.display = 'flex';
        setTimeout(() => {
          closeTimerModal();
        }, 5000);
      }
    }

    function closeTimerModal() {
      document.getElementById('timerModal').style.display = 'none';
    }

    function submitQuiz() {
      if (isSubmitted) return;
      
      isSubmitted = true;
      clearInterval(timerInterval);
      
      if (answeredQuestions < totalQuestions) {
        if (!confirm(`Вы ответили только на ${answeredQuestions} из ${totalQuestions} вопросов. Завершить тест?`)) {
          isSubmitted = false;
          startTimer();
          return;
        }
      }
      
      // Show loading modal
      document.getElementById('loadingModal').style.display = 'flex';
      
      // Disable submit button
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      document.getElementById('submitText').textContent = 'Обработка...';
      
      // Submit form
      document.getElementById('quizForm').submit();
    }

    // Enhanced option selection
    function setupOptionHandlers() {
      document.querySelectorAll('.option-radio').forEach(radio => {
        radio.addEventListener('change', function() {
          const label = this.closest('.option-label');
          const questionCard = this.closest('.question-card');
          
          // Remove selected class from all options in this question
          questionCard.querySelectorAll('.option-label').forEach(opt => {
            opt.classList.remove('border-primary', 'bg-primary/5');
            opt.classList.add('border-primary/20');
          });
          
          // Add selected class to current option
          label.classList.add('border-primary', 'bg-primary/5');
          label.classList.remove('border-primary/20');
          
          // Update progress
          updateProgress();
        });
      });
    }

    // Form submission
    document.getElementById('quizForm').addEventListener('submit', function(e) {
      e.preventDefault();
      submitQuiz();
    });

    // Start timer when page loads
    document.addEventListener('DOMContentLoaded', function() {
      startTimer();
      setupOptionHandlers();
      updateProgress();
    });

    // Prevent page refresh with unsaved changes
    window.addEventListener('beforeunload', function(e) {
      if (!isSubmitted) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (isSubmitted) return;
      
      // Allow A, B, C keys to select options
      if (['a', 'b', 'c'].includes(e.key.toLowerCase())) {
        const activeElement = document.activeElement;
        if (activeElement && activeElement.closest('.question-card')) {
          const questionCard = activeElement.closest('.question-card');
          const option = questionCard.querySelector(`input[value="${e.key.toUpperCase()}"]`);
          if (option) {
            option.checked = true;
            option.dispatchEvent(new Event('change'));
          }
        }
      }
    });
  </script>
{% endblock %}
